{"ast":null,"code":"import firebase from 'firebase';\nimport EventEmitter from 'events';\n\nclass ContentManager extends EventEmitter {\n  constructor() {\n    super();\n    this.unsubs = [];\n    this.articles = [];\n    this.userDocument = void 0;\n    this.authenticated = void 0;\n    this.isAdmin = void 0;\n\n    if (!firebase.apps.length) {\n      firebase.initializeApp({\n        apiKey: 'AIzaSyA9hYjJ-QSNR9xoy8qaCf-0lq4pyWHBu60',\n        authDomain: 'psy-website-2cd73.firebaseapp.com',\n        projectId: 'psy-website-2cd73',\n        storageBucket: 'psy-website-2cd73.appspot.com',\n        messagingSenderId: '469038815545',\n        appId: '1:469038815545:web:d16aa8f224d5bd86e8f0e8',\n        measurementId: 'G-S5X1QPJ92J'\n      });\n    } else {\n      firebase.app();\n    }\n\n    this.authenticated = !!firebase.auth().currentUser;\n    this.unsubs.push(firebase.auth().onAuthStateChanged(this.handleAuthChanged.bind(this)));\n    this.unsubs.push(firebase.firestore().collection('articles').onSnapshot(this.handleContentChanged.bind(this)));\n    window.contentManager = this;\n  }\n\n  destroy() {\n    this.unsubs.forEach(unsub => unsub === null || unsub === void 0 ? void 0 : unsub());\n    this.removeAllListeners();\n  }\n\n  async handleAuthChanged(user) {\n    this.authenticated = !!user;\n\n    if (user) {\n      var _this$userDocument;\n\n      this.userDocument = (await firebase.firestore().collection('users').doc(user.uid).get()).data();\n      this.isAdmin = ((_this$userDocument = this.userDocument) === null || _this$userDocument === void 0 ? void 0 : _this$userDocument.role) === 'admin';\n\n      if (this.userDocument && !this.userDocument.purchasedArticles) {\n        var _this$userDocument$re;\n\n        (_this$userDocument$re = this.userDocument.ref) === null || _this$userDocument$re === void 0 ? void 0 : _this$userDocument$re.set({\n          purchasedArticles: []\n        }, {\n          merge: true\n        });\n      }\n    }\n\n    this.handleContentChanged();\n    this.emit('auth', user);\n  }\n\n  async handleContentChanged() {\n    const db = firebase.firestore();\n    const articleDocs = (await db.collection('articles').get()).docs;\n    const articles = articleDocs.map(doc => doc.data());\n    await Promise.all(articleDocs.map(async (doc, index) => {\n      var _this$userDocument2;\n\n      const purchased = (_this$userDocument2 = this.userDocument) === null || _this$userDocument2 === void 0 ? void 0 : _this$userDocument2.purchasedArticles.includes(doc.id);\n      articles[index].purchased = purchased;\n      articles[index].id = doc.id;\n\n      if (purchased || this.isAdmin) {\n        var _await$doc$ref$collec;\n\n        articles[index].data = await ((_await$doc$ref$collec = (await doc.ref.collection('full').doc('content').get()).data()) === null || _await$doc$ref$collec === void 0 ? void 0 : _await$doc$ref$collec.data);\n      }\n    }));\n    this.articles = articles;\n    this.emit('article', articles);\n  }\n\n  addListener(event, listener) {\n    return super.addListener(event, listener);\n  }\n\n  async modifyArticle(id, description, title, data) {\n    let article = firebase.firestore().collection('articles').doc(id);\n    await article.update({\n      description: description,\n      title: title\n    });\n    await article.collection('full').doc('content').update({\n      data: data\n    });\n    console.log('updated article!');\n  }\n\n  async createArticle(description, title, data) {\n    let article = firebase.firestore().collection('articles').doc();\n    await article.set({\n      description: description,\n      title: title\n    });\n    await article.collection('full').doc('content').set({\n      data: data\n    });\n  }\n\n  async saveArticle(id, description, title, data) {\n    let article = firebase.firestore().collection('articles').doc(id).collection('draft').doc(\"content\");\n    await article.set({\n      description: description,\n      title: title,\n      data: data\n    });\n    console.log(\"Saved article to draft\");\n  }\n\n  async publishArticle(id) {\n    let article = firebase.firestore().collection('articles').doc(id);\n    let draft = article.collection(\"draft\").doc(\"content\").get();\n    await article.set({\n      description: draft.description,\n      title: title\n    });\n    await article.collection('full').doc('content').set({\n      data: data\n    });\n  }\n\n}\n\nconst contentManager = new ContentManager();\nexport default contentManager;","map":{"version":3,"sources":["/Users/emilessung/dev/psy-website/src/ContentManager.ts"],"names":["firebase","EventEmitter","ContentManager","constructor","unsubs","articles","userDocument","authenticated","isAdmin","apps","length","initializeApp","apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId","measurementId","app","auth","currentUser","push","onAuthStateChanged","handleAuthChanged","bind","firestore","collection","onSnapshot","handleContentChanged","window","contentManager","destroy","forEach","unsub","removeAllListeners","user","doc","uid","get","data","role","purchasedArticles","ref","set","merge","emit","db","articleDocs","docs","map","Promise","all","index","purchased","includes","id","addListener","event","listener","modifyArticle","description","title","article","update","console","log","createArticle","saveArticle","publishArticle","draft"],"mappings":"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","sourcesContent":["import {Article, UserDoc} from './interfaces';\nimport firebase from 'firebase';\nimport EventEmitter from 'events';\n\nclass ContentManager extends EventEmitter {\n    private unsubs: (firebase.Unsubscribe | undefined)[] = [];\n    public articles: Article[] = [];\n    public userDocument?: UserDoc;\n    public authenticated: boolean;\n    public isAdmin?: boolean;\n\n    constructor() {\n        super();\n\n        if (!firebase.apps.length) {\n            firebase.initializeApp({\n                apiKey: 'AIzaSyA9hYjJ-QSNR9xoy8qaCf-0lq4pyWHBu60',\n                authDomain: 'psy-website-2cd73.firebaseapp.com',\n                projectId: 'psy-website-2cd73',\n                storageBucket: 'psy-website-2cd73.appspot.com',\n                messagingSenderId: '469038815545',\n                appId: '1:469038815545:web:d16aa8f224d5bd86e8f0e8',\n                measurementId: 'G-S5X1QPJ92J'\n            });\n        } else {\n            firebase.app();\n        }\n\n        this.authenticated = !!firebase.auth().currentUser;\n        this.unsubs.push(firebase.auth().onAuthStateChanged(this.handleAuthChanged.bind(this)));\n        this.unsubs.push(firebase.firestore().collection('articles').onSnapshot(this.handleContentChanged.bind(this)));\n\n        (window as any).contentManager = this;\n    }\n\n    public destroy() {\n        this.unsubs.forEach(unsub => unsub?.());\n        this.removeAllListeners();\n    }\n\n    private async handleAuthChanged(user: firebase.User | null) {\n        this.authenticated = !!user;\n\n        if (user) {\n            this.userDocument = (await firebase.firestore().collection('users').doc(user.uid).get()).data() as UserDoc;\n            this.isAdmin = this.userDocument?.role === 'admin';\n            if (this.userDocument && !this.userDocument.purchasedArticles) {\n                this.userDocument.ref?.set(\n                    {\n                        purchasedArticles: []\n                    },\n                    {merge: true}\n                );\n            }\n        }\n\n        this.handleContentChanged();\n\n        this.emit('auth', user);\n    }\n\n    private async handleContentChanged() {\n        const db = firebase.firestore();\n        const articleDocs = (await db.collection('articles').get()).docs;\n        const articles = articleDocs.map(doc => doc.data() as Article);\n        await Promise.all(\n            articleDocs.map(async (doc, index) => {\n                const purchased = this.userDocument?.purchasedArticles.includes(doc.id);\n                articles[index].purchased = purchased;\n                articles[index].id = doc.id;\n                if (purchased || this.isAdmin) {\n                    articles[index].data = await (await doc.ref.collection('full').doc('content').get()).data()?.data;\n                }\n            })\n        );\n\n        this.articles = articles;\n        this.emit('article', articles);\n    }\n\n    public addListener(event: 'auth', listener: (user: firebase.User | null) => void): this;\n    public addListener(event: 'article', listener: (article: Article[]) => void): this;\n    public addListener(event: string, listener: (...args: any[]) => void): this {\n        return super.addListener(event, listener);\n    }\n\n    async modifyArticle(id: string, description: string, title: string, data: string) {\n        let article = firebase.firestore().collection('articles').doc(id);\n\n        await article.update({description: description, title: title});\n        await article.collection('full').doc('content').update({data: data});\n        console.log('updated article!');\n    }\n\n    async createArticle(description: string, title: string, data: string) {\n        let article = firebase.firestore().collection('articles').doc();\n\n        await article.set({\n            description: description,\n            title: title\n        });\n\n        await article.collection('full').doc('content').set({data: data});\n    }\n\n    async saveArticle(id: string, description: string, title: string, data: string) {\n        let article = firebase.firestore().collection('articles').doc(id).collection('draft').doc(\"content\");\n        \n        await article.set({\n            description: description,\n            title: title,\n            data: data\n        });\n\n        console.log(\"Saved article to draft\");\n    }\n\n    async publishArticle(id: string) {\n        let article = firebase.firestore().collection('articles').doc(id);\n        let draft = article.collection(\"draft\").doc(\"content\").get();\n\n        await article.set({\n            description: draft. description,\n            title: title\n        });\n\n        await article.collection('full').doc('content').set({data: data});\n    }\n}\n\nconst contentManager = new ContentManager();\n\nexport default contentManager;\n"]},"metadata":{},"sourceType":"module"}